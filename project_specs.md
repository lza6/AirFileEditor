# Project Specifications: tfgwj (听风改文件) V3.1.0

## 1. 项目愿景 (Vision)
打造业界领先的 Android 文件自动化管理工具，专注于高效、安全、无痛的 `/Android/data` 目录文件替换与优化。

## 2. 核心功能 (Core Features)

### Omni-Mode 智能检测系统 (v3.1.0 核心)
- **自动模式识别**: 智能检测 Root、Native、Shizuku 三种访问模式
- **物理验证机制**: 对每种模式进行实际的文件读写测试
- **最佳模式选择**: 根据设备环境和权限状态自动选择最优方案
- **手动模式切换**: 提供模式选择对话框，允许高级用户手动指定

### 高性能 IO 引擎 (v3.1.0 核心)
- **IoOptimizer 优化引擎**: 动态缓冲区管理 + 并发控制
- **NIO Zero-Copy**: 接近硬件极限的文件复制速度
- **增量更新算法**: MD5 哈希比对，只更新变化的文件
- **智能缓存管理**: 针对 UE4 游戏的 .pixuicache 优化

### 多格式支持
- **解压引擎**: 7z、Zip、Rar 多格式支持
- **流式处理**: 大文件解压不占用过多内存
- **加密压缩包**: 支持自动密码识别

### 文件时间管理
- **随机时间**: 一键随机化文件修改时间
- **时间锁定**: 锁定指定时间戳
- **时间应用**: 批量应用时间到目标文件

### 用户体验
- **全异步执行**: 基于 WorkManager 与协程
- **悬浮球监控**: 后台任务状态实时显示
- **智能日志**: 结构化日志系统
- **Material 3 UI**: 现代化界面设计

## 3. 技术栈 (Tech Stack)

### 核心技术
- **语言**: Kotlin (1.9.0+)
- **架构**: 响应式管理器 (Manager Pattern) + WorkManager
- **异步处理**: Kotlin Coroutines + Flow

### 关键库
- **Shizuku**: 跨进程文件访问（Root 替代方案）
- **DataStore**: 持久化偏好设置
- **WorkManager**: 后台任务管理
- **Material Components**: UI 组件库
- **Zip4j**: Zip 格式解压
- **Apache Commons Compress**: 7z/Rar 格式解压

### 性能优化
- **NIO (New IO)**: 零拷贝文件传输
- **Semaphore**: 并发控制
- **对象池**: 缓冲区复用
- **协程调度器**: 线程池优化

## 4. 关键指标 (KPIs)

### 性能指标
- **文件复制速度**: P99 延迟接近硬件 IO 极限（100MB/s+ 针对 UFS 3.1）
- **解压速度**: 7z 解压速度 > 50MB/s
- **内存占用**: 峰值控制在 150MB 以内
- **并发性能**: 16 并发处理，线性扩展

### 可靠性指标
- **成功率**: 替换任务成功率 > 99.5%
- **自动重试**: 失败自动重试机制
- **异常处理**: 完善的错误捕获和日志记录

### 用户体验指标
- **响应时间**: UI 操作响应时间 < 100ms
- **权限检测**: Omni-Mode 检测时间 < 3s
- **任务启动**: Worker 启动时间 < 500ms

## 5. 系统架构

### 核心模块
```
MainActivity (UI 层)
    ↓
PermissionManager (权限管理)
    ↓
PermissionChecker (权限检测)
    ↓
Omni-Mode System (智能模式选择)
    ↓
┌─────────────┬─────────────┬─────────────┐
│  Root Mode  │ Native Mode │ Shizuku Mode│
└─────────────┴─────────────┴─────────────┘
    ↓
FileReplaceWorker (后台任务)
    ↓
IoOptimizer (IO 优化)
    ↓
文件操作 (复制/解压/时间修改)
```

### 数据流
```
用户操作 → UI 事件 → 管理器处理 → 后台任务 → IO 操作 → 结果反馈
```

## 6. 版本历史

### v3.1.0 (当前版本)
- ✅ Omni-Mode 智能检测系统
- ✅ 手动模式选择对话框
- ✅ IoOptimizer 性能优化引擎
- ✅ 动态缓冲区管理
- ✅ 并发控制优化
- ✅ 改进权限检查系统

### v2.0.0
- ✅ Shizuku 高性能文件读写引擎
- ✅ 智能哈希比对（增量更新）算法
- ✅ 多格式压缩包智能识别与解压
- ✅ 文件时间修改功能
- ✅ 实时日志系统与悬浮窗进度管理
- ✅ 全新 Logo 应用

## 7. 待办路线图 (Roadmap)

### 近期计划 (V3.2)
- [ ] Shizuku 稳定性卫士（Watchdog 机制）
- [ ] 增量更新算法优化（抽样哈希）
- [ ] 大文件分块处理优化
- [ ] 内存占用进一步优化

### 中期计划 (V4.0)
- [ ] UI/UX 工业级重塑（Material 3 + 动效）
- [ ] 结构化日志与自诊断系统
- [ ] 云端配置支持
- [ ] 多线程并发 Shizuku Copy

### 长期愿景
- [ ] AI 智能修复（自动分析并修复损坏的游戏资源文件）
- [ ] 跨平台支持（桌面版/Web版）
- [ ] 插件系统（支持用户自定义功能）
- [ ] 社区生态（用户共享配置和脚本）

## 8. 技术难点与解决方案

### 难点 1: Android 11+ 的分区存储限制
**解决方案**: 使用 Shizuku 提供的跨进程访问能力，绕过分区存储限制。

### 难点 2: 大文件解压导致 OOM
**解决方案**: 使用流式解压 + 动态缓冲区管理，避免一次性加载整个文件到内存。

### 难点 3: 多种权限环境的兼容性
**解决方案**: Omni-Mode 智能检测系统，自动识别并选择最佳访问模式。

### 难点 4: 后台任务被系统杀死
**解决方案**: 使用 WorkManager 的持久化机制 + 前台服务 + 悬浮球保活。

### 难点 5: 文件复制速度慢
**解决方案**: NIO Zero-Copy + 并发控制 + 增量更新算法。

## 9. 测试策略

### 单元测试
- [ ] 核心算法测试（MD5、哈希比对）
- [ ] 权限检测逻辑测试
- [ ] IO 优化器测试

### 集成测试
- [ ] 完整替换流程测试
- [ ] 多模式切换测试
- [ ] 异常场景处理测试

### 性能测试
- [ ] 大文件处理性能测试
- [ ] 并发处理压力测试
- [ ] 内存占用监控测试

### 兼容性测试
- [ ] 不同 Android 版本测试（10-15）
- [ ] 不同设备厂商测试
- [ ] Root/非 Root 环境测试

## 10. 开发规范

### 代码规范
- 遵循 Kotlin 官方编码规范
- 使用 Material Design 3 设计规范
- 代码注释使用中文，关键逻辑添加英文注释

### Git 规范
- 分支管理: main（主分支）、dev（开发分支）、feature/*（功能分支）
- 提交规范: feat/fix/docs/style/refactor/test/chore
- 提交信息: 使用 Conventional Commits 规范

### 文档规范
- README: 面向普通用户，简洁易懂
- API 文档: 面向开发者，详细完整
- 设计文档: 面向架构师，深入浅出